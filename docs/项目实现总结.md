# 2-RC 锂电池等效电路模型 — 项目实现总结

本文档汇总当前项目在 **thevenin** 包基础上完成的所有工作与实现内容，便于复现、扩展与论文/报告引用。

---

## 一、项目目标与范围

- **目标**：在 thevenin 原有 2-RC 等效电路框架上，增加**热平衡**、**外电路功耗**、**老化（SOH）** 等能力，并支持用**实测数据（如 NASA PCoE .mat）**进行**贝叶斯优化调参**。
- **应用场景**：手机电池类工况（待机 / 高负载阶跃）、室温环境、多年使用下的健康度衰减预测；亦可对接 NASA 等公开数据集做参数辨识与验证。
- **约定**：电流正=放电；电压单位 V，电流 A，时间 s，温度 K（内部）或 °C（数据/显示）；容量 Ah。

---

## 二、模型与方程

### 2.1 电学部分（2-RC 等效电路）

- **结构**：1 个串联电阻 R0 + 2 个并联 RC 对（R1-C1、R2-C2）。端电压：
  $$V_{\rm cell} = V_{\rm OCV}({\rm SOC}, T) + h - \sum_j \eta_j - I R_0.$$
- **状态量**：SOC、迟滞 \(h\)、RC 过电位 \(\eta_1,\eta_2\)；\(h\) 当前关闭（\(\gamma=0,\, M_{\rm hyst}=0\)）。
- **动力学**：
  - \(\displaystyle\frac{d{\rm SOC}}{dt} = -\frac{\eta_{\rm ce} I}{3600\, Q_{\rm max}}\)；
  - \(\displaystyle\frac{d\eta_j}{dt} = -\frac{\eta_j}{R_j C_j} + \frac{I}{C_j}\)。
- **OCV**：\(V_{\rm OCV}({\rm SOC}, T)\) 为 SOC 的 7 次多项式 + 温度线性项 \((T - T_{\rm ref})\cdot {\rm dUoc/dT}\)（系数在 `params_2rc_isothermal.yaml`）。
- **R/C 与温度**：
  - 内阻用 **Arrhenius**：\(R(T) = R_{\rm ref} \exp\bigl[\frac{E_a}{k}(\frac{1}{T} - \frac{1}{T_{\rm ref}})\bigr]\)，温度升高 R 降低；
  - 极化电容：\(C(T) = C_{\rm ref} \exp\bigl[E_{a,C}(\frac{1}{T} - \frac{1}{T_{\rm ref}})\bigr]\)，温升略增（系数在 yaml）。

### 2.2 热学部分（脚本内实现）

- **热平衡**（在 `simple_2rc_step_by_step.py` 中每步更新）：
  $$m C_p \frac{dT}{dt} = Q_{\rm gen} - Q_{\rm diss},$$
  - **产热**：\(Q_{\rm gen} = I^2 R_{\rm total}(T,{\rm SOC}) + P_{\rm device}(t)\)（电池 I²R + 外电路 CPU/屏等传入电芯的功率）；
  - **散热**：\(Q_{\rm diss} = h A (T - T_{\infty})\)（对流，\(h\)：对流换热系数，\(A\)：有效散热面积，\(T_\infty\)：环境温度）。
- 参数：`mass`、`Cp`、`h_therm`、`A_therm`、`T_inf` 来自 yaml；\(P_{\rm device}(t)\) 由脚本中工况函数给出。

### 2.3 电压/电流截止（脚本内实现）

- **放电截止**：当 \(I>0\) 且 \(V \le V_{\rm MIN}\) 时停止该步之后仿真；
- **充电截止**：当 \(I<0\) 且 \(V \ge V_{\rm MAX}\) 时停止；
- 默认：\(V_{\rm MIN}=2.5\,{\rm V}\)，\(V_{\rm MAX}=4.25\,{\rm V}\)，避免满电初始时误判。

### 2.4 老化（SOH）与参数随 SOH 更新

- **每日老化结算**（`calculate_aging`）：
  - 输入：当日平均温度 \(T_{\rm avg}\)、安时通过量 Ah、额定容量 \(Q_{\rm nom}\)；
  - 公式：\(\Delta{\rm SOH} \propto k_{\rm aging}\, ({\rm Ah}/Q_{\rm nom})^z\, \exp\bigl[\frac{E_a}{R}(\frac{1}{T_{\rm avg}} - \frac{1}{T_{\rm ref}})\bigr]\)，单日 loss 上限 1% 保护。
- **参数随 SOH 更新**（`update_battery_params`）：
  - 容量：\(\text{capacity} = Q_{\rm nom} \times {\rm SOH}\)；
  - 内阻：\(R({\rm SOH}) = R_{\rm base}(soc,T) \times \bigl(1 + r_{\rm SOH}(1-{\rm SOH})\bigr)\)，\(r_{\rm SOH}=0.8\)。

---

## 三、参数与配置文件

### 3.1 主参数文件

- **路径**：`src/thevenin/_resources/params_2rc_isothermal.yaml`。
- **内容**：`num_RC_pairs=2`，`soc0`、`capacity`、`ce`、迟滞（gamma/M_hyst，当前为 0）、热学（mass、Cp、T_inf、h_therm、A_therm）、OCV 多项式与温度系数、R0/R1/R2/C1/C2 的 lambda（含 Arrhenius/C(T) 表达式）。
- **说明**：包内 `isothermal=True` 仅表示包自身不求解温度；脚本在外部按热平衡方程更新 \(T_{\rm cell}\)。

### 3.2 待验证/标定参数清单

- **路径**：`scripts/待验证参数清单.md`。
- **内容**：逐项列出 yaml 与脚本中需用实测数据标定或验证的**约 40 项**（含 16 项 yaml 数值、4 项结构开关、截止与工况、老化公式、SOH 更新等），并给出建议标定顺序（电学 → 热学 → 工况 → 老化）以及**脚本/模型需要的数据类型**（仿真驱动、标定、验证、老化标定）。

---

## 四、脚本与实现功能

### 4.1 主演示与老化脚本：`scripts/simple_2rc_step_by_step.py`

| 功能 | 说明 |
|------|------|
| **阶跃电流 I(t)** | 模拟手机：待机(0.1 A) → 游戏(2 A) → 待机，时段 0~0.2 h、0.2~0.5 h、0.5~1 h。 |
| **外电路功耗 P_device(t)** | 待机 0.05 W，游戏 3 W（单次 1 h 演示）；老化日工况：游戏 1 W，待机 0.05 W。 |
| **单次 1 h 演示** | 固定步长 1 s，从满电/常温起步，每步：`take_step` → 更新电压/温度 → 判断 V_MIN/V_MAX 截止 → 记录 t/V/SOC/I/T/P_device；结果绘图保存为 SVG。 |
| **每日工况** | `I_daily_A(t_s)`：前 2 h 为 2 A，其余 22 h 为 0.1 A；`P_device_daily_W(t_s)` 对应 1 W / 0.05 W。 |
| **run_one_day** | 给定 SOH、步长(如 60 s)、24 h、I_fn/P_device_fn；每天从满电/常温开始；统计当日 T_avg、Ah_throughput、DOD 等并返回。 |
| **calculate_aging** | 根据当日 T_avg、Ah、Q_nominal 计算 SOH 下降量（含单日上限）。 |
| **update_battery_params** | 按当前 SOH 更新 `pred.capacity` 与 R0/R1/R2（线性容量 + 内阻随 SOH 增大）。 |
| **老化循环** | `RUN_AGING=True` 时：循环多天，每天先 `update_battery_params` → `run_one_day` → `calculate_aging` → 更新 SOH；可绘制 SOH–时间(年) 曲线。 |
| **输出图** | 单次演示：I(t)、P_device(t)、V、SOC、T(t)；老化：SOH vs 年。图存为 `figureN_描述.svg`。 |

### 4.2 贝叶斯调参脚本：`scripts/bayesian_tune_params.py`

| 功能 | 说明 |
|------|------|
| **数据加载** | 从 `data_Parameter tuning/*.mat` 读取 NASA PCoE 格式；支持顶层 key 为 `cycle` 或 `B0005` 等（`mat_struct` 或数组），提取所有 **discharge** 周期的 Time、Voltage_measured、Current_measured、Temperature_measured。 |
| **模型构建** | 用 yaml 基参 + 当前优化参数（R0_ref、R1_ref、R2_ref、C1_ref、C2_ref）构建 2-RC `Prediction`；容量固定为 2 Ah（与 NASA 额定一致）；R/C 仍用 Arrhenius/C(T) 形式。 |
| **单周期仿真** | 用实测电流序列驱动模型（可变步长，大步长可再细分），得到与实测时间点对齐的仿真电压；初始 SOC=1、T 用实测或环境温度。 |
| **目标函数** | 各放电周期「仿真电压 vs 实测电压」的 RMSE，再对周期取平均（或中位数）；最小化该 RMSE。 |
| **贝叶斯优化** | 使用 `scikit-optimize` 的 `gp_minimize`，在 R0_ref/R1_ref/R2_ref/C1_ref/C2_ref 的给定边界内搜索；可配置 N_CALLS、N_INITIAL、random_state。 |
| **输出** | `scripts/bayesian_tune_result.json`（最优参数与 RMSE）；`scripts/bayesian_tune_best_params_snippet.txt`（可复制到 yaml 的数值片段）。 |

### 4.3 其它脚本

- **scripts/requirements_tuning.txt**：调参依赖（scikit-optimize、scipy）。
- **scripts/test.py**：用于探测 .mat 结构的临时脚本（如 B0005 的 type、cycle 等）。
- **scripts/version_checker.py**：版本检查，与模型核心无关。

---

## 五、数据需求（与待验证参数清单一致）

### 5.1 仿真驱动（用数据替代 I/P_device）

- **最少**：时间 t (s)、电流 I (A)。
- **可选**：P_device (W)。

### 5.2 标定用（拟合参数）

- **最少**：t、I、端电压 V。
- **推荐**：t、I、V、温度 T；或单独 OCV–SOC 曲线、脉冲/EIS、温升曲线。

### 5.3 验证用（评估精度）

- 与标定同结构、不同样本：t、I、V，可选 T、SOC。

### 5.4 老化标定用（可选）

- 循环次数/日历时间、容量或 SOH、内阻随 SOH/cycle；可选 T_avg、Ah_throughput。

### 5.5 NASA .mat 使用方式

- 将 B0005.mat 等放入 `data_Parameter tuning/`；贝叶斯脚本会自动读取其中所有放电周期用于优化。

---

## 六、输出文件与图表

| 文件 | 说明 |
|------|------|
| **figure1_最初结果（常数电流，不考虑温度，磁滞）.svg** | 早期常数电流、不考虑温度/迟滞的示例。 |
| **figure2_电流变为阶跃信号.svg** | 阶跃电流下的 V/SOC 等。 |
| **figure3_加入温度热平衡.svg** | 加入热平衡后的 V、SOC、T。 |
| **figure4_加入外电路功耗.svg** | 加入 P_device(t) 后的 I、P_device、V、SOC、T。 |
| **figure5_老化SOH.svg** | 多年老化下 SOH 随年份变化。 |
| **bayesian_tune_result.json** | 贝叶斯优化得到的最优 R0_ref/R1_ref/R2_ref/C1_ref/C2_ref 与 RMSE。 |
| **bayesian_tune_best_params_snippet.txt** | 最优参数的可读片段。 |

---

## 七、关键文件结构速览

```
thevenin/
├── src/thevenin/
│   ├── _resources/
│   │   └── params_2rc_isothermal.yaml   # 2-RC + 热学 + OCV/R/C(T)
│   ├── _basemodel.py                    # 基类、yaml 读取、RHS
│   ├── _prediction.py                   # Prediction、TransientState、take_step
│   ├── _simulation.py                   # Simulation（本项目主要用 Prediction）
│   └── ...
├── scripts/
│   ├── simple_2rc_step_by_step.py       # 演示 + 老化主脚本
│   ├── bayesian_tune_params.py          # NASA .mat + 贝叶斯调参
│   ├── 待验证参数清单.md                 # 参数与数据需求清单
│   ├── requirements_tuning.txt          # 调参依赖
│   ├── figure*.svg                      # 结果图
│   └── bayesian_tune_result.json        # 调参结果（运行后生成）
├── data_Parameter tuning/               # NASA 等 .mat 数据目录
│   └── B0005.mat 等
├── README.md                            # 包说明（含 2-RC 方程与热学公式）
└── docs/
    └── 项目实现总结.md                   # 本文档
```

---

## 八、运行方式简要

1. **安装**（项目根目录 thevenin 下）：
   ```bash
   pip install -e .
   pip install -r scripts/requirements_tuning.txt   # 仅调参需要
   ```
2. **单次演示或老化**：
   ```bash
   python scripts/simple_2rc_step_by_step.py
   ```
   - 修改脚本内 `RUN_AGING`、`AGING_DAYS` 等可切换单次 1 h 演示 / 多年老化。
3. **贝叶斯调参**（需先在 `data_Parameter tuning/` 放入 .mat）：
   ```bash
   python scripts/bayesian_tune_params.py
   ```

---

## 九、与原始 thevenin 包的差异（本项目的扩展）

- **热学**：包内 `isothermal=True`，温度由**脚本**按 \(mC_p dT/dt = Q_{\rm gen} - Q_{\rm diss}\) 每步更新，且 \(Q_{\rm gen}\) 包含 **P_device(t)**。
- **工况**：I(t)、P_device(t) 由**脚本内函数**给出（阶跃/日工况），未从外部文件读入；贝叶斯脚本则从 .mat 读 I、V、T 驱动模型。
- **老化**：**脚本层**实现“天”级循环、SOH 结算与 capacity/R 随 SOH 更新，包内无老化模块。
- **电压截止**：在脚本的 `run_one_day` 与单次演示循环中判断 V_MIN/V_MAX 并提前结束。
- **数据与调参**：NASA .mat 加载、放电周期提取、贝叶斯优化与结果保存均在 **scripts** 中实现，不修改包核心。

以上即为当前模型与脚本的完整工作与实现总结。
